<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendar Cita - Barbería Michael</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(to bottom, #0d0d0d, #1c1c1c);
      color: #eee;
      font-family: 'Montserrat', sans-serif;
      min-height: 100vh;
      padding-bottom: 50px;
    }
    nav.navbar {
      background: #000;
    }
    .navbar-brand {
      font-weight: 700;
      color: #f39c12 !important;
      font-size: 1.7rem;
    }
    main {
      max-width: 700px;
      margin: 40px auto;
      background: #1e1e1e;
      border-radius: 12px;
      padding: 30px 40px;
      box-shadow: 0 0 30px rgba(243,156,18,0.4);
    }
    h2 {
      text-align: center;
      font-weight: 700;
      color: #f39c12;
      margin-bottom: 25px;
    }
    label {
      font-weight: 600;
      color: #ccc;
    }
    input.form-control, select.form-select {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #eee;
    }
    input::placeholder {
      color: #aaa;
    }
    input:focus, select:focus {
      border-color: #f39c12;
      box-shadow: 0 0 8px #f39c12;
      background: #333;
    }
    .btn-primary {
      background-color: #f39c12;
      border: none;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 30px;
      padding: 12px 0;
    }
    .btn-primary:hover {
      background-color: #d17e0a;
    }
    .img-barber {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    #duracion-texto {
      font-size: 0.9rem;
      color: #f39c12;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    #servicios-agregados {
      margin-top: 20px;
      background: #222;
      border-radius: 8px;
      padding: 15px;
      max-height: 220px;
      overflow-y: auto;
    }
    #servicios-agregados ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #servicios-agregados li {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 1px solid #444;
      padding-bottom: 8px;
    }
    #servicios-agregados img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
    }
    #total-info {
      font-size: 1rem;
      font-weight: 700;
      color: #f39c12;
      margin-top: 15px;
      text-align: center;
    }
    .btn-remove-service {
      margin-left: auto;
      background: transparent;
      border: none;
      color: #e74c3c;
      font-size: 1.3rem;
      cursor: pointer;
    }
    .btn-remove-service:hover {
      color: #c0392b;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">Barbería Michael</a>
    </div>
  </nav>

  <main>
    <img src="/static/logo michael elias perfil.jpg" alt="Barbería" class="img-barber">

    <h2>Reserva tu cita</h2>

    <form method="POST" id="form-cita" autocomplete="off">

      <div class="mb-3">
        <label for="nombre">Nombre completo</label>
        <input required type="text" id="nombre" name="nombre" class="form-control" placeholder="Tu nombre completo" />
      </div>

      <div class="mb-3">
        <label for="email">Correo electrónico</label>
        <input required type="email" id="email" name="email" class="form-control" placeholder="ejemplo@correo.com" />
      </div>

      <div class="mb-3">
        <label for="telefono">Teléfono</label>
        <input required type="tel" id="telefono" name="telefono" class="form-control" placeholder="+56 9 1234 5678" />
      </div>

      <div class="mb-3">
        <label for="servicio">Selecciona un servicio</label>
        <select id="servicio" class="form-select">
          <option value="" disabled selected>Selecciona un servicio</option>
          <option 
            value="Corte de cabello" 
            data-duracion="30" 
            data-precio="12000" 
            data-img="https://i.imgur.com/qzv9N4O.jpg"
          >Corte de cabello</option>
          <option 
            value="Afeitado" 
            data-duracion="20" 
            data-precio="8000" 
            data-img="https://i.imgur.com/ZpGfOqX.jpg"
          >Afeitado</option>
          <option 
            value="Barba" 
            data-duracion="25" 
            data-precio="10000" 
            data-img="https://i.imgur.com/1U5Gv6Z.jpg"
          >Barba</option>
          <option 
            value="Corte + Barba" 
            data-duracion="50" 
            data-precio="18000" 
            data-img="https://i.imgur.com/2zQpzfh.jpg"
          >Corte + Barba</option>
          <option 
            value="Ceja" 
            data-duracion="15" 
            data-precio="7000" 
            data-img="https://i.imgur.com/7vYbrVQ.jpg"
          >Ceja</option>
        </select>
      </div>

      <button type="button" id="btn-agregar" class="btn btn-primary w-100 mb-3" disabled>Agregar servicio</button>

      <div id="servicios-agregados">
        <strong>Servicios agregados:</strong>
        <ul id="lista-servicios"></ul>
      </div>

      <div id="total-info">Duración total: 0 minutos | Precio total: $0 CLP</div>

      <div class="mb-3 mt-4">
        <label for="fecha">Fecha</label>
        <input required type="text" id="fecha" name="fecha" class="form-control" placeholder="Selecciona una fecha" readonly />
      </div>

      <div class="mb-3">
        <label for="hora">Hora</label>
        <select required id="hora" name="hora" class="form-select" disabled>
          <option value="">Primero selecciona una fecha y servicios</option>
        </select>
      </div>

      <!-- Inputs ocultos para enviar servicios en el formulario -->
      <div id="inputs-servicios"></div>

      <button type="submit" class="btn btn-primary w-100 mt-3">Agendar cita</button>
    </form>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const servicioSelect = document.getElementById('servicio');
    const btnAgregar = document.getElementById('btn-agregar');
    const listaServicios = document.getElementById('lista-servicios');
    const totalInfo = document.getElementById('total-info');
    const inputsServicios = document.getElementById('inputs-servicios');
    const fechaInput = document.getElementById('fecha');
    const horaSelect = document.getElementById('hora');

    let serviciosAgregados = [];

    servicioSelect.addEventListener('change', () => {
      btnAgregar.disabled = !servicioSelect.value;
    });

    btnAgregar.addEventListener('click', () => {
      const selectedOption = servicioSelect.options[servicioSelect.selectedIndex];
      const servicio = {
        nombre: selectedOption.value,
        duracion: parseInt(selectedOption.dataset.duracion),
        precio: parseInt(selectedOption.dataset.precio),
        img: selectedOption.dataset.img
      };

      // Evitar agregar el mismo servicio dos veces
      if (serviciosAgregados.some(s => s.nombre === servicio.nombre)) {
        alert('Este servicio ya fue agregado');
        return;
      }

      serviciosAgregados.push(servicio);
      actualizarLista();
      servicioSelect.value = "";
      btnAgregar.disabled = true;
      // Cada vez que se actualiza la lista, si hay fecha seleccionada recarga horas
      if(fechaInput.value) cargarHorasDisponibles(fechaInput.value);
    });

    function actualizarLista() {
      listaServicios.innerHTML = '';
      inputsServicios.innerHTML = '';
      let totalDuracion = 0;
      let totalPrecio = 0;

      serviciosAgregados.forEach((servicio, index) => {
        totalDuracion += servicio.duracion;
        totalPrecio += servicio.precio;

        // Crear el item de la lista
        const li = document.createElement('li');

        li.innerHTML = `
          <img src="${servicio.img}" alt="${servicio.nombre}" />
          <div>
            <strong>${servicio.nombre}</strong><br/>
            Duración: ${servicio.duracion} min<br/>
            Precio: $${servicio.precio.toLocaleString()} CLP
          </div>
          <button type="button" class="btn-remove-service" data-index="${index}" title="Quitar servicio">&times;</button>
        `;

        listaServicios.appendChild(li);

        // Crear inputs ocultos para enviar los servicios al backend
        const inputNombre = document.createElement('input');
        inputNombre.type = 'hidden';
        inputNombre.name = `servicios[${index}][nombre]`;
        inputNombre.value = servicio.nombre;

        const inputDuracion = document.createElement('input');
        inputDuracion.type = 'hidden';
        inputDuracion.name = `servicios[${index}][duracion]`;
        inputDuracion.value = servicio.duracion;

        inputsServicios.appendChild(inputNombre);
        inputsServicios.appendChild(inputDuracion);
      });

      totalInfo.textContent = `Duración total: ${totalDuracion} minutos | Precio total: $${totalPrecio.toLocaleString()} CLP`;

      // Si no hay servicios, deshabilitar el select hora
      horaSelect.disabled = serviciosAgregados.length === 0;
      if(horaSelect.disabled) {
        horaSelect.innerHTML = '<option value="">Primero selecciona servicios y fecha</option>';
      }
    }

    // Delegación para quitar servicio
    listaServicios.addEventListener('click', e => {
      if(e.target.classList.contains('btn-remove-service')) {
        const index = parseInt(e.target.dataset.index);
        serviciosAgregados.splice(index, 1);
        actualizarLista();
        if(fechaInput.value) cargarHorasDisponibles(fechaInput.value);
      }
    });

    flatpickr("#fecha", {
      minDate: "today",
      dateFormat: "Y-m-d",
      disableMobile: true,
      locale: {
        firstDayOfWeek: 1
      },
      onChange: function(selectedDates, dateStr) {
        if (serviciosAgregados.length > 0) {
          cargarHorasDisponibles(dateStr);
        } else {
          horaSelect.innerHTML = '<option value="">Primero selecciona servicios</option>';
          horaSelect.disabled = true;
        }
      }
    });

    function cargarHorasDisponibles(fecha) {
      const totalDuracion = serviciosAgregados.reduce((sum, s) => sum + s.duracion, 0);

      fetch('/horas_disponibles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fecha: fecha, duracion: totalDuracion })
      })
      .then(res => res.json())
      .then(data => {
        horaSelect.innerHTML = '';
        if (data.length === 0) {
          horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
          horaSelect.disabled = true;
          return;
        }
        data.forEach(h => {
          const op = document.createElement("option");
          op.value = h;
          op.textContent = h;
          horaSelect.appendChild(op);
        });
        horaSelect.disabled = false;
      });
    }
  </script>
</body>
</html>
